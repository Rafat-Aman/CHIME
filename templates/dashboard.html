{% extends "base.html" %}
{% load socialaccount %}

{% block title %}Dashboard · MyProject{% endblock %}

{% block content %}
  <div class="page-head">
    <h2>Your Dashboard</h2>
    <div class="page-actions">
      <a class="btn-outline" href="{% url 'home' %}">Home</a>
      <a class="btn-outline" href="{% url 'profile' %}">Profile</a>
      <a class="btn btn-google" href="{% provider_login_url 'google' process='connect' %}">
        <span class="g-icon"></span> Connect another Google account
      </a>
    </div>
  </div>

  {% if total %}
  <!-- Aggregate donut (top-right corner). No CSS here; styled via site.css -->
  <aside class="disk-widget" aria-label="Aggregate storage">
    {% if total.limit_bytes %}
      <div class="donut" data-pct="{{ total.pct_used|default:0 }}">
        <div class="donut-center">
          <div class="donut-fig">{{ total.avail_h }}</div>
          <div class="donut-cap">free</div>
        </div>
      </div>
      <div class="disk-meta">
        <div><strong>{{ total.used_h }}</strong> used</div>
        <div class="muted">of {{ total.limit_h }} total</div>
      </div>
    {% else %}
      <div class="donut unlimited">
        <div class="donut-center">
          <div class="donut-fig">∞</div>
          <div class="donut-cap">unlimited</div>
        </div>
      </div>
      <div class="disk-meta">
        <div><strong>{{ total.used_h }}</strong> used</div>
        <div class="muted">total is unlimited</div>
      </div>
    {% endif %}
  </aside>
  {% endif %}

  <section class="card">
    <div class="card-head">
      <h3>Connected Google accounts</h3>
    </div>

    {% if items %}
      <ul class="accounts">
        {% for item in items %}
          {% with acc=item.account data=item.account.extra_data q=item.quota err=item.error %}
          <li class="account">
            <div class="account-main">
              {% if data.picture %}<img class="avatar" src="{{ data.picture }}" alt="">{% endif %}
              <div class="meta">
                <div class="name">{{ data.name|default:acc.uid }}</div>
                <div class="sub">{{ data.email|default:"(no email)" }}</div>

                {% if q %}
                  <dl class="details" style="margin-top:8px">
                    <dt>Drive used</dt><dd>{{ q.usage }}</dd>
                    <dt>Plan limit</dt><dd>{{ q.limit }}</dd>
                    {% if q.remaining %}<dt>Free left</dt><dd>{{ q.remaining }}</dd>{% endif %}
                  </dl>
                {% endif %}

                {% if err %}
                  <div class="error">
                    Drive quota error: {{ err }}
                    {% if "ACCESS_TOKEN_SCOPE_INSUFFICIENT" in err or "insufficientPermissions" in err or "Insufficient Permission" in err %}
                      <div class="hint">This account was connected before Drive access was requested.</div>
                      <a class="btn small btn-google" href="{% provider_login_url 'google' process='connect' %}">
                        <span class="g-icon"></span> Grant Drive access
                      </a>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            </div>

            <form class="account-actions" action="{% url 'disconnect_google' acc.pk %}" method="post" onsubmit="return confirm('Disconnect this Google account?');">
              {% csrf_token %}
              <button class="btn-outline small" type="submit">Disconnect</button>
            </form>
          </li>
          {% endwith %}
        {% endfor %}
      </ul>
    {% else %}
      <p>No Google accounts linked yet.</p>
    {% endif %}
  </section>

  <!-- Tiny script to set CSS var from data-pct without inline CSS -->
  <script>
    (function(){
      var donut = document.querySelector('.donut[data-pct]');
      if(!donut) return;
      var pct = parseInt(donut.getAttribute('data-pct') || '0', 10);
      if (isNaN(pct) || pct < 0) pct = 0;
      if (pct > 100) pct = 100;
      donut.style.setProperty('--p', pct);
    })();
  </script>
{% endblock %}
